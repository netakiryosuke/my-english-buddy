# My English Buddy

My English Buddy は、OpenAI API を利用した英会話練習用のデスクトップアプリケーションです。

マイクから音声を継続的に聞き取り、OpenAI Speech-to-Text で文字起こしし、OpenAI Chat Completions で会話応答を生成し、OpenAI Text-to-Speech で音声化して話しかけます。シンプルな GUI ウィンドウで会話ログを表示します。

このプロジェクトは現在も **開発中** です。README は網羅的ではなく、実用的な内容を優先しています。

## 概要

- **インターフェース**: GUI アプリケーション（PySide6）、会話ログを表示
- **入力**: 継続的なマイク聞き取り、音声自動検出
- **ウェイクワード**: "buddy" と言って会話を開始（初回のみ必要）
- **文字起こし**: OpenAI 音声認識 API（`gpt-4o-mini-transcribe` にハードコード）
- **応答**: OpenAI Chat Completions API（`OPENAI_MODEL` を使用）
- **音声出力**: OpenAI Text-to-Speech API（`gpt-4o-mini-tts`、`alloy` ボイスにハードコード）
- **メモリ**: セッション中、最大 50 メッセージの会話履歴をメモリ内に保持
- **割り込み**: アシスタントの発話中に話しかけると、即座に停止します

現在の制限事項（この段階では想定内）:

- メモリはセッション間で保存されません（再起動時にクリア）
- 永続的なストレージや会話履歴のエクスポート機能なし
- TTS モデルとボイスは環境変数で設定できません

## 必要要件

- **Python**: 3.12（`.python-version` 参照）
- **OpenAI API キー**: 使用するモデル（文字起こし、チャット、TTS）へのアクセス権が必要
- **マイクアクセス** と動作するオーディオスタック
- **音声出力**（スピーカーまたはヘッドフォン）
- **uv**（推奨）: リポジトリには `uv.lock` が含まれています

## セットアップ

1) 環境ファイルを作成します:

```bash
cp .env.example .env
```

2) `.env` を編集し、少なくとも `OPENAI_API_KEY` と `OPENAI_MODEL` を設定します。

3) 依存関係をインストールします（推奨）:

```bash
uv sync
```

4) アプリケーションを実行します:

```bash
uv run python -m app.main
```

GUI ウィンドウが開き、聞き取りを開始します。"buddy" と言って起動し、その後は自然に英語で話してください。アシスタントが音声で返答します。

オプション: システムプロンプトのカスタマイズ（推奨）:

```bash
cp prompt.txt.example prompt.txt
# prompt.txt を編集してアシスタントの動作をカスタマイズ
```

別の dotenv ファイルを読み込む場合:

```bash
uv run python -m app.main --env-file path/to/.env
```

dotenv の読み込みを完全に無効にする場合は、空の値を渡します:

```bash
uv run python -m app.main --env-file ""
```

## 動作の仕組み

1. **聞き取り**: アプリはバックグラウンドでマイクを継続的に聞き取ります
2. **ウェイクワード**: "buddy" と言って会話を開始します（セッション中に一度だけ必要）
3. **音声入力**: 起動後は自然に話してください。話し終わったことを自動検出します
4. **文字起こし**: 音声が OpenAI Speech-to-Text API を使ってテキストに変換されます
5. **チャット**: 文字起こしされたテキストが会話履歴とともに OpenAI Chat Completions API に送信されます
6. **音声出力**: アシスタントの応答が OpenAI Text-to-Speech API を使って音声化されます
7. **再生**: 音声がスピーカー/ヘッドフォンから再生されます
8. **割り込み**: アシスタントが話している間に話しかけると割り込むことができます

会話メモリは、応答生成のために直近 20 メッセージをコンテキストとして保持し、セッション中は最大 50 メッセージを保存します。メモリはアプリ再起動時にクリアされます。

## 環境変数

環境変数でアプリを設定できます（通常は `.env` に記述）。

| 名前 | 必須 | デフォルト | 説明 |
| --- | --- | --- | --- |
| `OPENAI_API_KEY` | Yes | - | OpenAI SDK で使用される API キー |
| `OPENAI_MODEL` | Yes | - | 応答に使用するチャットモデル（例: `gpt-4o-mini`） |
| `OPENAI_BASE_URL` | No | - | API ベース URL を上書き（プロキシ/互換エンドポイント用） |
| `MY_ENGLISH_BUDDY_SYSTEM_PROMPT` | No | - | インラインのシステムプロンプトテキスト。設定されている場合、プロンプトファイルより優先されます |
| `MY_ENGLISH_BUDDY_SYSTEM_PROMPT_FILE` | No | `prompt.txt` | システムプロンプトを含むテキストファイルのパス。ファイルが存在し、空でない場合のみ使用されます |

システムプロンプトの解決順序:

1) `MY_ENGLISH_BUDDY_SYSTEM_PROMPT`（環境変数）
2) `MY_ENGLISH_BUDDY_SYSTEM_PROMPT_FILE`（デフォルト: `prompt.txt`）ファイルが存在し、空でない場合
3) アプリケーションに組み込まれたデフォルトプロンプト

## 設定

### システムプロンプト

システムプロンプトは、アシスタントのパーソナリティと動作を定義します。3 つの方法でカスタマイズできます（優先順）:

1. **環境変数**: `MY_ENGLISH_BUDDY_SYSTEM_PROMPT` を直接設定
2. **プロンプトファイル**: `MY_ENGLISH_BUDDY_SYSTEM_PROMPT_FILE` で指定されたファイルを作成/編集（デフォルト: `prompt.txt`）
3. **組み込みデフォルト**: どちらも提供されていない場合、組み込みの英語チュータープロンプトを使用

例:

```bash
# カスタムプロンプトファイルを使用
cp prompt.txt.example prompt.txt
# prompt.txt を希望する指示内容で編集

# または環境変数を使用
export MY_ENGLISH_BUDDY_SYSTEM_PROMPT="フレンドリーな英語チューターとして振る舞ってください。返答は短めに。"
uv run python -m app.main
```

## 開発

### テストの実行

プロジェクトには、コアアプリケーションロジック用のユニットテストが含まれています。テストを実行するには:

```bash
uv sync  # テスト依存関係をインストール
uv run pytest
```

注意: テストは高速で依存関係のないように、インフラストラクチャ/GUI レイヤーはカバーしていません。

## トラブルシューティング

### マイクが動作しない

- **macOS/Linux**: ターミナルまたは Python にマイクの権限があることを、システム環境設定/設定で確認してください
- **すべてのプラットフォーム**: マイクが正しく接続され、デフォルトの入力デバイスとして設定されているか確認してください
- このアプリ以外で、簡単なオーディオテストを実行してマイクが動作するか確認してください

### 音声が出力されない

- スピーカー/ヘッドフォンが接続され、動作していることを確認してください
- システムの音量設定を確認してください
- OpenAI TTS API にアクセスできることを確認してください（API キーとネットワーク接続を確認）

### OpenAI API エラー

- `.env` で `OPENAI_API_KEY` が正しく設定されていることを確認してください
- API キーが必要なモデルへのアクセス権を持っていることを確認してください:
  - `gpt-4o-mini-transcribe`（Speech-to-Text）
  - 選択した `OPENAI_MODEL`（Chat Completions）
  - `gpt-4o-mini-tts`（Text-to-Speech）
- OpenAI サービスへのネットワーク接続を確認してください

### ウェイクワードが動作しない

- 最初に "buddy" をはっきりと言ってください
- GUI ログウィンドウで音声が文字起こしされているか確認してください
- ウェイクワードはセッション中に一度だけ言う必要があります

## 例: カスタムプロンプト

```bash
cp prompt.txt.example prompt.txt

# または独自のプロンプトファイルを作成
echo "あなたは英語チューターです。簡潔に。ミスは優しく訂正してください。" > prompt.txt
uv run python -m app.main
```
